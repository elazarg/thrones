<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Game Theory Workbench</title>
    <style>
      :root {
        font-family: "Inter", system-ui, -apple-system, sans-serif;
        background: #0d1117;
        color: #e6edf3;
      }
      body {
        margin: 0;
        display: grid;
        grid-template-rows: auto 1fr auto;
        height: 100vh;
      }
      header, footer {
        background: #161b22;
        padding: 12px 16px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        border-bottom: 1px solid #30363d;
      }
      footer {
        border-top: 1px solid #30363d;
        border-bottom: none;
        gap: 12px;
        flex-wrap: wrap;
      }
      main {
        display: grid;
        grid-template-columns: 2fr 1fr;
        gap: 16px;
        padding: 16px;
      }
      .canvas {
        border: 1px dashed #30363d;
        border-radius: 12px;
        padding: 16px;
        background: radial-gradient(circle at 10% 20%, rgba(32, 65, 82, 0.3), transparent 25%),
          radial-gradient(circle at 90% 10%, rgba(70, 35, 92, 0.3), transparent 30%),
          #0d1117;
        min-height: 360px;
      }
      .status-bar {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
      }
      .chip {
        background: #1f6feb33;
        border: 1px solid #1f6feb88;
        padding: 6px 10px;
        border-radius: 999px;
        display: flex;
        align-items: center;
        gap: 6px;
        font-size: 14px;
      }
      .panel {
        background: #161b22;
        border: 1px solid #30363d;
        border-radius: 12px;
        padding: 12px;
      }
      .analysis-list h3 {
        margin: 0 0 8px;
      }
      .node, .action, .outcome {
        margin-bottom: 8px;
      }
      .action span {
        color: #7ee0ff;
      }
      .outcome {
        color: #8df4a3;
      }
      .warning {
        color: #f0a93b;
        font-size: 12px;
      }
      #llm-box {
        margin-top: 12px;
        padding: 10px;
        border: 1px dashed #30363d;
        border-radius: 8px;
        background: #0f1724;
      }
      input[type="text"] {
        width: 100%;
        padding: 8px 10px;
        border-radius: 8px;
        border: 1px solid #30363d;
        background: #0d1117;
        color: #e6edf3;
      }
    </style>
  </head>
  <body>
    <header>
      <div>
        <strong id="game-title">Game Theory Workbench</strong>
        <span id="game-version" style="color:#8b949e; margin-left:8px;"></span>
      </div>
      <div style="display:flex; gap:8px;">
        <button id="simulate-btn">Simulate ‚ñ∂</button>
        <button id="llm-btn">üí¨ LLM</button>
      </div>
    </header>
    <main>
      <section class="canvas">
        <h2 style="margin-top:0">Canvas</h2>
        <div id="nodes"></div>
        <div id="llm-box">
          <label for="llm-input">Continuous LLM</label>
          <input id="llm-input" type="text" placeholder="Ask to modify the game..." />
          <p style="margin:8px 0 0; color:#8b949e">Changes would create new versions automatically.</p>
        </div>
      </section>
      <section class="panel analysis-list">
        <h3>Analyses (continuous)</h3>
        <div id="analyses"></div>
      </section>
    </main>
    <footer>
      <div class="status-bar" id="status-bar"></div>
      <div style="margin-left:auto">‚öôÔ∏è Configure</div>
    </footer>
    <script>
      async function fetchJson(url) {
        const response = await fetch(url);
        if (!response.ok) throw new Error(await response.text());
        return response.json();
      }

      function renderGame(game) {
        document.getElementById("game-title").textContent = game.title;
        document.getElementById("game-version").textContent = game.version;

        const nodesEl = document.getElementById("nodes");
        nodesEl.innerHTML = "";

        const stack = [game.root];
        while (stack.length) {
          const id = stack.pop();
          const node = game.nodes[id];
          if (!node) continue;

          const nodeEl = document.createElement("div");
          nodeEl.className = "node";
          nodeEl.innerHTML = `<strong>${node.player}</strong>`;
          nodesEl.appendChild(nodeEl);

          node.actions.forEach((action) => {
            const actionEl = document.createElement("div");
            actionEl.className = "action";
            const prob = action.probability ? ` (${(action.probability * 100).toFixed(0)}%)` : "";
            actionEl.innerHTML = `‚Üí <span>${action.label}</span>${prob}`;
            if (action.warning) {
              actionEl.innerHTML += `<div class="warning">‚ö† ${action.warning}</div>`;
            }
            nodeEl.appendChild(actionEl);

            const outcome = game.outcomes[action.target];
            if (outcome) {
              const outEl = document.createElement("div");
              outEl.className = "outcome";
              outEl.textContent = `${outcome.label} ‚Äî ${JSON.stringify(outcome.payoffs)}`;
              nodeEl.appendChild(outEl);
            } else {
              stack.push(action.target);
            }
          });
        }
      }

      function renderAnalyses(results) {
        const list = document.getElementById("analyses");
        const bar = document.getElementById("status-bar");
        list.innerHTML = "";
        bar.innerHTML = "";

        results.forEach((result) => {
          const card = document.createElement("div");
          card.className = "panel";
          card.style.marginBottom = "8px";
          card.innerHTML = `<strong>${result.summary}</strong>`;

          const eqs = result.details.equilibria || [];
          eqs.forEach((eq) => {
            const p = document.createElement("p");
            p.textContent = eq.description;
            card.appendChild(p);

            const behavior = document.createElement("p");
            behavior.style.color = "#7ee0ff";
            behavior.textContent = `Behavior: ${JSON.stringify(eq.behavior_profile)}`;
            card.appendChild(behavior);

            const outcomes = document.createElement("p");
            outcomes.style.color = "#8df4a3";
            outcomes.textContent = `Outcomes: ${JSON.stringify(eq.outcomes)}`;
            card.appendChild(outcomes);
          });

          list.appendChild(card);

          const chip = document.createElement("div");
          chip.className = "chip";
          chip.innerHTML = `‚úì ${result.summary}`;
          bar.appendChild(chip);
        });
      }

      async function boot() {
        const [game, analyses] = await Promise.all([
          fetchJson("/api/game"),
          fetchJson("/api/analyses"),
        ]);
        renderGame(game);
        renderAnalyses(analyses);
      }

      boot().catch((err) => {
        console.error(err);
        document.body.innerHTML = `<pre>${err}</pre>`;
      });
    </script>
  </body>
</html>
