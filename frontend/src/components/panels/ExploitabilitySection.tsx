import { isExploitabilityResult } from '../../types';

export interface ExploitabilitySectionProps {
  result: { summary: string; details: Record<string, unknown> } | null;
  isLoading: boolean;
  isExpanded: boolean;
  disabled?: boolean;
  disabledReason?: string;
  onToggle: () => void;
  onRun: () => void;
  onCancel: () => void;
}

export function ExploitabilitySection({
  result,
  isLoading,
  isExpanded,
  disabled,
  disabledReason,
  onToggle,
  onRun,
  onCancel,
}: ExploitabilitySectionProps) {
  const hasResult = !!result;
  const canExpand = (hasResult || isLoading) && !disabled;
  const details = isExploitabilityResult(result?.details) ? result.details : null;

  const handleHeaderClick = () => {
    if (disabled) return;
    if (canExpand) {
      onToggle();
    } else {
      onRun();
    }
  };

  // Determine quality badge color
  const getQualityClass = (quality: string) => {
    const q = quality.toLowerCase();
    if (q.includes('near-optimal') || q.includes('essentially nash')) return 'good';
    if (q.includes('very good') || q.includes('good')) return 'moderate';
    return 'poor';
  };

  return (
    <div className={`analysis-section ${isExpanded && canExpand ? 'expanded' : ''}`}>
      <div
        className={`analysis-trigger ${hasResult ? 'has-result' : ''} ${disabled ? 'disabled' : ''}`}
        onClick={handleHeaderClick}
        title={disabled ? disabledReason : "Measure distance from Nash equilibrium"}
      >
        <span className="trigger-icon">
          {isLoading ? (
            <span className="spinner-small"></span>
          ) : canExpand ? (
            isExpanded ? '▼' : '▶'
          ) : (
            '▶'
          )}
        </span>
        <span className="trigger-text">Exploitability</span>

        <div className="trigger-badges">
          {disabled && (
            <span className="platform-badge">Unavailable</span>
          )}
          {result?.details.computation_time_ms !== undefined && (
            <span className="timing-badge">{result.details.computation_time_ms as number}ms</span>
          )}
          {details && (
            <span className={`quality-badge ${getQualityClass(details.quality)}`}>
              {details.nash_conv.toFixed(4)}
            </span>
          )}
        </div>

        {isLoading && (
          <button type="button" className="stop-link" onClick={(e) => { e.stopPropagation(); onCancel(); }}>Stop</button>
        )}
      </div>

      {isExpanded && canExpand && (
        <div className="analysis-content">
          {isLoading && !result && (
            <div className="analysis-loading">
              <span>Computing...</span>
            </div>
          )}

          {hasResult && details && (
            <div className="exploitability-result">
              <div className="scalar-result">
                <div className="value-display">
                  <span className="value">{details.nash_conv.toFixed(6)}</span>
                  <span className="label">Nash Conv</span>
                </div>
                <div className={`quality-indicator ${getQualityClass(details.quality)}`}>
                  {details.quality}
                </div>
              </div>

              <p className="policy-info">Policy: {details.policy_type}</p>

              <div className="analysis-section-footer">
                <button type="button" className="rerun-link" onClick={(e) => { e.stopPropagation(); onRun(); }}>
                  Recompute
                </button>
              </div>
            </div>
          )}

          {hasResult && !details && (
            <div className="analysis-error">
              <p>{result.summary}</p>
            </div>
          )}
        </div>
      )}
    </div>
  );
}
