# Docker Compose configuration for Game Theory Workbench
# Usage: docker-compose up
#
# Environment variables can be set in .env file (see .env.example)

# Healthcheck defaults - used by plugins via YAML anchors
x-healthcheck-defaults: &healthcheck-defaults
  interval: 10s
  timeout: 5s
  retries: 5

services:
  base:
    build:
      context: .
      dockerfile: docker/Dockerfile.base
    image: thrones-base:latest

  app:
    build:
      context: .
      dockerfile: docker/Dockerfile.app
    ports:
      - "8000:8000"
    environment:
      - GAMBIT_URL=http://gambit:5001
      - PYCID_URL=http://pycid:5002
      - EGTTOOLS_URL=http://egttools:5003
      - VEGAS_URL=http://vegas:5004
      - OPENSPIEL_URL=http://openspiel:5005
    depends_on:
      base:
        condition: service_started
      gambit:
        condition: service_healthy
      pycid:
        condition: service_healthy
      egttools:
        condition: service_healthy
      vegas:
        condition: service_healthy
      openspiel:
        condition: service_healthy
    healthcheck:
      <<: *healthcheck-defaults
      test: ["CMD", "curl", "-f", "http://localhost:8000/api/health"]
      start_period: 10s

  gambit:
    build:
      context: .
      dockerfile: docker/Dockerfile.gambit
    depends_on:
      - base
    ports:
      - "5001:5001"
    healthcheck:
      <<: *healthcheck-defaults
      test: ["CMD", "curl", "-f", "http://localhost:5001/health"]
      start_period: 30s  # Gambit library initialization
    restart: on-failure

  pycid:
    build:
      context: .
      dockerfile: docker/Dockerfile.pycid
    depends_on:
      - base
    ports:
      - "5002:5002"
    healthcheck:
      <<: *healthcheck-defaults
      test: ["CMD", "curl", "-f", "http://localhost:5002/health"]
      start_period: 60s  # PyCID takes longer to initialize (pgmpy, pycid imports)
    restart: on-failure

  egttools:
    build:
      context: .
      dockerfile: docker/Dockerfile.egttools
    depends_on:
      - base
    ports:
      - "5003:5003"
    healthcheck:
      <<: *healthcheck-defaults
      test: ["CMD", "curl", "-f", "http://localhost:5003/health"]
      start_period: 15s
    restart: on-failure

  vegas:
    build:
      context: .
      dockerfile: docker/Dockerfile.vegas
    depends_on:
      - base
    ports:
      - "5004:5004"
    healthcheck:
      <<: *healthcheck-defaults
      test: ["CMD", "curl", "-f", "http://localhost:5004/health"]
      start_period: 15s
    restart: on-failure

  openspiel:
    build:
      context: .
      dockerfile: docker/Dockerfile.openspiel
    depends_on:
      - base
    ports:
      - "5005:5005"
    healthcheck:
      <<: *healthcheck-defaults
      test: ["CMD", "curl", "-f", "http://localhost:5005/health"]
      start_period: 30s  # OpenSpiel library initialization
    restart: on-failure

networks:
  default:
    name: thrones-network
